pipeline {
    agent { label 'linux_02' }

    environment {
        WORKSPACE_DIR = "${env.WORKSPACE}"
        RESULT_DIR    = "${env.WORKSPACE}/Result"
        VENV_PATH     = "${env.WORKSPACE}/venv"
        PYTHON        = "${env.WORKSPACE}/venv/bin/python"
        PIP           = "${env.WORKSPACE}/venv/bin/pip"
        PLAYWRIGHT    = "${env.WORKSPACE}/venv/bin/playwright"
    }

    stages {

        stage('Setup Python Environment') {
            steps {
                script {
                    dir(env.WORKSPACE_DIR) {

                        sh '''
                            echo "ğŸ Python ê°€ìƒí™˜ê²½ ìë™ ìƒì„±..."

                            # Python venv ìƒì„±
                            python3 -m venv venv

                            echo "ğŸ“¦ pip ì—…ê·¸ë ˆì´ë“œ..."
                            venv/bin/pip install --upgrade pip

                            echo "ğŸ“¦ requirements.txt ì„¤ì¹˜..."
                            venv/bin/pip install -r requirements.txt

                            echo "ğŸ­ Playwright ì„¤ì¹˜..."
                            venv/bin/playwright install chromium
                        '''
                    }
                }
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    dir(env.WORKSPACE_DIR) {

                        withCredentials([
                            file(credentialsId: 'todolist_dev_env_test', variable: 'ENV_FILE')
                        ]) {

                            sh '''
                                ###################################################
                                # ğŸ” í™˜ê²½ ë³€ìˆ˜ ë¡œë”© (ë¯¼ê°ì •ë³´ echo ë°©ì§€)
                                ###################################################
                                set +x
                                echo "ğŸ“Œ í™˜ê²½ ë³€ìˆ˜ ë¡œë”© ì‹œì‘..."

                                set -a
                                while IFS= read -r line || [ -n "$line" ]; do
                                    trimmed=$(echo "$line" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

                                    if [ -z "$trimmed" ] || [ "$(printf %.1s "$trimmed")" = "#" ]; then
                                        continue
                                    fi

                                    if echo "$trimmed" | grep -q "="; then
                                        key=$(echo "$trimmed" | cut -d '=' -f 1)
                                        value=$(echo "$trimmed" | cut -d '=' -f 2-)
                                        export "$key=$value"
                                    fi
                                done < "$ENV_FILE"
                                set +a

                                echo "ğŸ” í™˜ê²½ ë³€ìˆ˜ ë¡œë”© ì™„ë£Œ!"
                                set -x

                                ###################################################
                                # â–¶ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
                                ###################################################
                                ${PYTHON} -m pytest --disable-warnings --maxfail=1 || true
                            '''
                        }
                    }
                }
            }
        }

        stage('Archive Test Report') {
            steps {
                script {
                    echo "ğŸ“„ HTML í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ë¥¼ ì €ì¥í•©ë‹ˆë‹¤..."

                    archiveArtifacts artifacts: 'Result/**/*.html', fingerprint: true
                }
            }
        }
    }

    post {
        always {
            script {
                echo "ğŸ‰ ì „ì²´ íŒŒì´í”„ë¼ì¸ ì™„ë£Œ!"
            }
        }
    }
}
