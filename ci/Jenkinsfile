pipeline {
    agent { label 'linux_02' }

    environment {
        WORKSPACE_DIR = "${env.WORKSPACE}"
        RESULT_DIR    = "${env.WORKSPACE}/Result"
        VENV_PATH     = "${env.WORKSPACE}/venv"
        PYTHON        = "${env.WORKSPACE}/venv/bin/python"
        PIP           = "${env.WORKSPACE}/venv/bin/pip"
        PLAYWRIGHT    = "${env.WORKSPACE}/venv/bin/playwright"
    }

    stages {

        stage('Setup Python Environment') {
            steps {
                sh '''
                    python3 -m venv venv
                    venv/bin/pip install --upgrade pip
                    venv/bin/pip install -r requirements.txt
                    venv/bin/playwright install chromium
                '''
            }
        }

        /* =======================================
        2. Validate & Refresh Tokens
        ======================================= */
        stage('Validate and Refresh Tokens') {
            steps {
                withCredentials([
                    file(credentialsId: 'todolist_dev_env_test', variable: 'ENV_FILE'),

                    string(credentialsId: 'KAKAO_ACCESS_TOKEN',  variable: 'KAKAO_ACCESS_TOKEN'),
                    string(credentialsId: 'KAKAO_REFRESH_TOKEN', variable: 'KAKAO_REFRESH_TOKEN'),
                    string(credentialsId: 'NAVER_ACCESS_TOKEN',  variable: 'NAVER_ACCESS_TOKEN'),
                    string(credentialsId: 'NAVER_REFRESH_TOKEN', variable: 'NAVER_REFRESH_TOKEN'),
                    string(credentialsId: 'WEB_TEST_JWT_TOKEN',  variable: 'WEB_TEST_JWT_TOKEN'),

                    usernamePassword(credentialsId: 'jenkins-admin',
                        usernameVariable: 'JENKINS_USER',
                        passwordVariable: 'JENKINS_PASS')
                ]) {

                    sh '''
                        set +x

                        export KAKAO_ACCESS_TOKEN="$KAKAO_ACCESS_TOKEN"
                        export KAKAO_REFRESH_TOKEN="$KAKAO_REFRESH_TOKEN"
                        export NAVER_ACCESS_TOKEN="$NAVER_ACCESS_TOKEN"
                        export NAVER_REFRESH_TOKEN="$NAVER_REFRESH_TOKEN"

                        export JENKINS_USER="$JENKINS_USER"
                        export JENKINS_PASS="$JENKINS_PASS"
                        export ENV_FILE="$ENV_FILE"

                        set -x

                        bash ci/check_token_valid.sh
                    '''
                }
            }
        }

        /* =======================================
        3. Run Tests (ENV_FILE ë¡œë”© ê¸ˆì§€!)
        ======================================= */
        stage('Run Tests') {
            steps {
                withCredentials([
                    string(credentialsId: 'KAKAO_ACCESS_TOKEN',  variable: 'KAKAO_ACCESS_TOKEN'),
                    string(credentialsId: 'KAKAO_REFRESH_TOKEN', variable: 'KAKAO_REFRESH_TOKEN'),
                    string(credentialsId: 'NAVER_ACCESS_TOKEN',  variable: 'NAVER_ACCESS_TOKEN'),
                    string(credentialsId: 'NAVER_REFRESH_TOKEN', variable: 'NAVER_REFRESH_TOKEN'),
                    string(credentialsId: 'WEB_TEST_JWT_TOKEN',  variable: 'WEB_TEST_JWT_TOKEN')
                ]) {

                    sh '''
                        set +x
                        export KAKAO_ACCESS_TOKEN="$KAKAO_ACCESS_TOKEN"
                        export KAKAO_REFRESH_TOKEN="$KAKAO_REFRESH_TOKEN"
                        export NAVER_ACCESS_TOKEN="$NAVER_ACCESS_TOKEN"
                        export NAVER_REFRESH_TOKEN="$NAVER_REFRESH_TOKEN"
                        export WEB_TEST_JWT_TOKEN="$WEB_TEST_JWT_TOKEN"
                        set -x

                        venv/bin/python -m pytest --disable-warnings --maxfail=1 || true
                    '''
                }
            }
        }


        /* =======================================
           4. Report ì €ìž¥
        ======================================= */
        stage('Archive Test Report') {
            steps {
                script {
                    echo "ðŸ“„ Saving HTML Test Reports..."
                    archiveArtifacts artifacts: 'Result/**/*.html', fingerprint: true
                }
            }
        }
    }

    post {
        always {
            script {
                echo "ðŸŽ‰ Pipeline Completed!"
            }
        }
    }
}
