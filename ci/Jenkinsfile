pipeline {
    agent {
        label 'linux_02'
    }
    
    environment {
        WORKSPACE_DIR = '/home/ubuntu/to_do_list_test'
        RESULT_DIR = '/home/ubuntu/todolist_test/Result'
    }
    
    stages {
        stage('Setup Environment') {
            steps {
                script {
                    // 프로젝트 루트 디렉토리로 이동 (/home/ubuntu/to_do_list_test)
                    dir(env.WORKSPACE_DIR) {
                        // Jenkins credential에서 .env 파일을 프로젝트 루트에 생성
                        withCredentials([file(credentialsId: 'todolist_dev_env_test', variable: 'ENV_FILE')]) {
                            sh '''
                                # .env 파일을 프로젝트 루트에 생성
                                cp "$ENV_FILE" .env
                                
                                # .env 파일 생성 확인
                                if [ ! -f .env ]; then
                                    echo "오류: .env 파일 생성에 실패했습니다."
                                    exit 1
                                fi
                                
                                # .env 파일 경로 출력
                                ENV_PATH=$(pwd)/.env
                                echo ".env 파일이 생성되었습니다: $ENV_PATH"
                                
                                # .env 파일 내용 확인 (민감 정보는 마스킹)
                                echo ".env 파일의 주요 설정 확인:"
                                grep -E "^[A-Z_]+=" .env | sed 's/=.*/=***/' | head -5
                            '''
                        }
                    }
                }
            }
        }
        
        stage('Run Tests') {
            steps {
                script {
                    dir(env.WORKSPACE_DIR) {
                        sh '''
                            # 가상환경 활성화 및 테스트 실행
                            source todolist_test/bin/activate && \
                            pytest || true
                        '''
                    }
                }
            }
        }
        
        stage('Copy Test Report') {
            steps {
                script {
                    dir(env.WORKSPACE_DIR) {
                        sh '''
                            # Result 디렉토리에서 가장 최신 폴더 찾기
                            LATEST_DIR=$(ls -td ${RESULT_DIR}/*/ 2>/dev/null | head -1)
                            
                            if [ -z "$LATEST_DIR" ]; then
                                echo "경고: Result 디렉토리에서 폴더를 찾을 수 없습니다."
                                exit 0
                            fi
                            
                            echo "가장 최신 폴더: $LATEST_DIR"
                            
                            # .html 파일 찾기 및 복사
                            HTML_FILE=$(find "$LATEST_DIR" -name "*.html" -type f | head -1)
                            
                            if [ -z "$HTML_FILE" ]; then
                                echo "경고: HTML 파일을 찾을 수 없습니다."
                                exit 0
                            fi
                            
                            echo "HTML 파일 발견: $HTML_FILE"
                            
                            # 파일명 추출
                            FILENAME=$(basename "$HTML_FILE")
                            
                            # Linux_ prefix를 붙여서 현재 디렉토리에 복사
                            cp "$HTML_FILE" "${WORKSPACE_DIR}/Linux_${FILENAME}"
                            
                            echo "파일이 복사되었습니다: Linux_${FILENAME}"
                        '''
                    }
                }
            }
        }
    }
    
    post {
        always {
            script {
                dir(env.WORKSPACE_DIR) {
                    echo "테스트 실행이 완료되었습니다."
                }
            }
        }
    }
}

