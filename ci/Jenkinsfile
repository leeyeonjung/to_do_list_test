pipeline {
    agent { label 'linux_02' }

    environment {
        WORKSPACE_DIR = '/home/ubuntu/todolist_test'
        RESULT_DIR    = '/home/ubuntu/todolist_test/Result'
    }

    stages {

        stage('Run Tests') {
            steps {
                script {
                    dir(env.WORKSPACE_DIR) {

                        withCredentials([file(credentialsId: 'todolist_dev_env_test', variable: 'ENV_FILE')]) {

                            sh '''
                                ###############################################
                                # ğŸ” ë¯¼ê° ì •ë³´ ë³´í˜¸: Jenkins ëª…ë ¹ echo ì¤‘ë‹¨
                                ###############################################
                                set +x

                                echo "ğŸ“Œ í™˜ê²½ ë³€ìˆ˜ ë¡œë”© ì‹œì‘..."

                                set -a
                                while IFS= read -r line || [ -n "$line" ]; do
                                    trimmed=$(echo "$line" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

                                    # ë¹ˆ ì¤„ ë˜ëŠ” ì£¼ì„ ì œì™¸
                                    if [ -z "$trimmed" ] || [ "$(printf %.1s "$trimmed")" = "#" ]; then
                                        continue
                                    fi

                                    # KEY=VALUE í˜•íƒœë§Œ ì²˜ë¦¬
                                    if echo "$trimmed" | grep -q "="; then
                                        key=$(echo "$trimmed" | cut -d '=' -f 1)
                                        value=$(echo "$trimmed" | cut -d '=' -f 2-)
                                        export "$key=$value"
                                    fi
                                done < "$ENV_FILE"
                                set +a

                                ###############################################
                                # ğŸ” ë¯¼ê° ì •ë³´ ì¶œë ¥ ë°©ì§€ ì™„ë£Œ â†’ Jenkins echo ë‹¤ì‹œ ì¼œê¸°
                                ###############################################
                                set -x

                                echo "ğŸ”‘ í™˜ê²½ ë³€ìˆ˜ ì•ˆì „í•˜ê²Œ ì£¼ì… ì™„ë£Œ!"

                                ###############################################
                                # â–¶ Playwright ë¸Œë¼ìš°ì € ìë™ ì„¤ì¹˜ (ì¤‘ìš”)
                                ###############################################
                                todolist_test/bin/playwright install chromium

                                ###############################################
                                # â–¶ .env íŒŒì¼ ê°±ì‹  ë°©ì§€ë¥¼ ìœ„í•œ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
                                #   í…ŒìŠ¤íŠ¸ ì½”ë“œì˜ update_oauth_env_file() ê°€ ì“°ê¸° ê¸ˆì§€ë˜ë„ë¡ ìœ ë„
                                ###############################################
                                export DISABLE_ENV_WRITE=true
                                echo "ğŸ›‘ í…ŒìŠ¤íŠ¸ ì¤‘ .env íŒŒì¼ì€ ë®ì–´ì“°ê¸° ê¸ˆì§€ë¨."

                                ###############################################
                                # â–¶ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
                                ###############################################
                                todolist_test/bin/python -m pytest || true
                            '''
                        }
                    }
                }
            }
        }

        stage('Copy Test Report') {
            steps {
                script {
                    dir(env.WORKSPACE_DIR) {
                        sh '''
                            echo "ğŸ“„ ìµœì‹  í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ì°¾ëŠ” ì¤‘..."

                            LATEST_DIR=$(ls -td ${RESULT_DIR}/*/ 2>/dev/null | head -1)

                            if [ -z "$LATEST_DIR" ]; then
                                echo "âš ï¸ ê²°ê³¼ í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤."
                                exit 0
                            fi

                            echo "ğŸ“ ìµœì‹  í´ë”: $LATEST_DIR"

                            HTML_FILE=$(find "$LATEST_DIR" -name "*.html" -type f | head -1)

                            if [ -z "$HTML_FILE" ]; then
                                echo "âš ï¸ HTML ë¦¬í¬íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤."
                                exit 0
                            fi

                            FILENAME=$(basename "$HTML_FILE")
                            cp "$HTML_FILE" "${WORKSPACE_DIR}/Linux_${FILENAME}"

                            echo "âœ… ë¦¬í¬íŠ¸ ë³µì‚¬ ì™„ë£Œ â†’ Linux_${FILENAME}"
                        '''
                    }
                }
            }
        }
    }

    post {
        always {
            script {
                dir(env.WORKSPACE_DIR) {
                    echo "ğŸ‰ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ë¦¬í¬íŠ¸ ì²˜ë¦¬ ì™„ë£Œ!"
                }
            }
        }
    }
}
