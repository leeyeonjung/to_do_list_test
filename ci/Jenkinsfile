pipeline {

    agent none   // 병렬 실행 위해 전체 agent 없음

    stages {

        stage('Run Tests on Linux & Windows') {
            parallel {

                /* -------------------------------------------------------------
                   Linux Tests
                ------------------------------------------------------------- */
                stage('Linux Tests') {
                    agent { label 'linux_02' }

                    environment {
                        VENV_PATH = "${env.WORKSPACE}/venv"
                        PYTHON    = "${env.WORKSPACE}/venv/bin/python"
                    }

                    steps {
                        sh """
                            python3 -m venv venv
                            venv/bin/pip install --upgrade pip
                            venv/bin/pip install -r requirements.txt
                        """

                        sh """
                            ${PYTHON} -m pytest --disable-warnings --maxfail=1
                        """
                    }
                }

                /* -------------------------------------------------------------
                   Windows Tests
                ------------------------------------------------------------- */
                stage('Windows Tests') {
                    agent { label 'windows_01' }

                    steps {
                        bat """
                            python -m venv venv
                            venv\\Scripts\\pip install --upgrade pip
                            venv\\Scripts\\pip install -r requirements.txt
                        """

                        bat """
                            venv\\Scripts\\python -m pytest --disable-warnings --maxfail=1
                        """
                    }
                }
            }
        }
    }

    post {
        success { echo "✔ ALL TESTS PASSED (Linux + Windows)" }
        failure { echo "❌ SOME TESTS FAILED" }
    }
}
