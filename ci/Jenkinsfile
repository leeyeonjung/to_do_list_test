pipeline {
    agent {
        label 'linux_02'
    }

    environment {
        WORKSPACE_DIR = '/home/ubuntu/todolist_test'
        RESULT_DIR    = '/home/ubuntu/todolist_test/Result'
    }

    stages {

        stage('Run Tests') {
            steps {
                script {
                    dir(env.WORKSPACE_DIR) {

                        // Jenkins Credentialì—ì„œ í…ŒìŠ¤íŠ¸ìš© env íŒŒì¼ ì£¼ì…
                        withCredentials([file(credentialsId: 'todolist_dev_env_test', variable: 'ENV_FILE')]) {
                            sh '''
                                echo "ğŸ“Œ í™˜ê²½ ë³€ìˆ˜ ë¡œë”© ì‹œì‘..."

                                set -a
                                while IFS= read -r line || [ -n "$line" ]; do
                                    # ì•ë’¤ ê³µë°± ì œê±°
                                    trimmed=$(echo "$line" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

                                    # ë¹ˆ ì¤„, ì£¼ì„ ì œì™¸
                                    if [ -z "$trimmed" ] || [ "$(printf %.1s "$trimmed")" = "#" ]; then
                                        continue
                                    fi

                                    # KEY=VALUE í˜•ì‹ë§Œ ì²˜ë¦¬
                                    if echo "$trimmed" | grep -q "="; then
                                        key=$(echo "$trimmed" | cut -d '=' -f 1)
                                        value=$(echo "$trimmed" | cut -d '=' -f 2-)
                                        export "$key=$value"
                                    fi
                                done < "$ENV_FILE"
                                set +a

                                echo "ğŸ”‘ í™˜ê²½ ë³€ìˆ˜ ì£¼ì… ì™„ë£Œ!"
                                env | grep -E "^(WEB_BASE_URL|BACKEND_BASE_URL|KAKAO_|NAVER_|JWT_)" | sed 's/=.*/=***/'

                                echo "ğŸ Python í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
                                todolist_test/bin/python -m pytest || true
                            '''
                        }
                    }
                }
            }
        }

        stage('Copy Test Report') {
            steps {
                script {
                    dir(env.WORKSPACE_DIR) {
                        sh '''
                            echo "ğŸ“„ ìµœì‹  í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ì°¾ëŠ” ì¤‘..."

                            # ìµœì‹  ë¦¬í¬íŠ¸ í´ë” ì°¾ê¸°
                            LATEST_DIR=$(ls -td ${RESULT_DIR}/*/ 2>/dev/null | head -1)

                            if [ -z "$LATEST_DIR" ]; then
                                echo "âš ï¸ Result ë””ë ‰í† ë¦¬ì—ì„œ í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
                                exit 0
                            fi

                            echo "ğŸ“ ìµœì‹  í´ë”: $LATEST_DIR"

                            # HTML ë¦¬í¬íŠ¸ ì°¾ê¸°
                            HTML_FILE=$(find "$LATEST_DIR" -name "*.html" -type f | head -1)

                            if [ -z "$HTML_FILE" ]; then
                                echo "âš ï¸ HTML íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
                                exit 0
                            fi

                            echo "ğŸ” HTML íŒŒì¼: $HTML_FILE"

                            FILENAME=$(basename "$HTML_FILE")

                            cp "$HTML_FILE" "${WORKSPACE_DIR}/Linux_${FILENAME}"

                            echo "âœ… ë¦¬í¬íŠ¸ ë³µì‚¬ ì™„ë£Œ â†’ Linux_${FILENAME}"
                        '''
                    }
                }
            }
        }
    }

    post {
        always {
            script {
                dir(env.WORKSPACE_DIR) {
                    echo "ğŸ‰ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ë¦¬í¬íŠ¸ ì²˜ë¦¬ ì™„ë£Œ!"
                }
            }
        }
    }
}
